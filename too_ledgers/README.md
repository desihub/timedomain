# ToO Ledger Builder

Parse target-of-opportunity (ToO) alerts from various sources, store the
resulting ToO in a database, and create an ASCII/ECSV ledger for processing ToO
secondary targets with fiberassign.

## Files

- ***toodb.py***: Encapsulation of the database for storing ToOs. The database
  is keyed by a unique TOOID.
- ***tooledger.py***: Encapsulate parsing of various ToO lists in various
  formats. This module is responsible for filling the ToO DB and subsequently
  producing a ToO ledger. Duplicate ToO IDs are not allowed.
- ***build_ledger.py***: Driver file for parsing ToO lists and converting them
  into a ledger + updated DB.

## Usage

If a ToO list is provided in `toolist.csv`, run

```
python build_ledger.py toolist.csv -o ToO-input.ecsv
```

to update the ToO database and the ASCII ToO ledger. This will append new ToOs
to the file ToO-input.ecsv if it already exists. To write only a new set of
entries to the file, specify a new output file each time the ledger builder is
run.

As of May 2022, the ledger should be appeneded to the end of the file
```
/pscratch/sd/a/adamyers/ToO/segev_put_it_here/ToO-input.ecsv
```
and Adam Meyers and Anand Raichoor should be informed of the update.

Example:
```
python build_ledger.py desirt/legaObj220430.csv -o ToO-input-20220430.ecsv

# Check output, then append to the master ledger.
cat ToO-input-20220430.ecsv >> /pscratch/sd/a/adamyers/ToO/segev_put_it_here/ToO-input.ecsv

# If all is OK, update the ToO database file under version control.
git commit too_list.db
git push origin master
```

## Details

The ToO ledger used by fiberassign cannot include duplicate ToO IDs, which are
stored as 32-bit integers. The role of the TOO SQLite database defined in
`toodb.py` is to track the alerts processed by this script and ensure that
duplicate ToO IDs are not allowed.

The ToO ID is generated by taking the MJD of the alert and the number of the
alert within a given MJD as follows:

```
tooid = ((mjd - 55197) << 18) + number
```

I.e., MJD is expressed with respect to 1 Jan 2010 and is stored as a 14-bit
number. That will allow valid storage through 10 Nov 2054. The event number
within the MJD takes up the 18 least significant bits, which means we can track
up to 262,144 unique alerts per night.

Encoding and decoding of the ToO ID is provided inside `toodb.py`. The database
classes ensure unique IDs for each alert, for each night.

The I/O to write the ledger is provided inside `tooledger.py`.
